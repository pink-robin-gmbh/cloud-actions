name: Build and push Docker image to registry

on:
  workflow_call:
    inputs:
      Repository:
        description: "Path/name of container repository (without registry URL)"
        type: string
      Dockerfile:
        description: "Filename of Dockerfile. Defaults to 'Dockerfile'"
        type: string
        default: "Dockerfile"

    secrets:
      registry_url:
        description: "URL of container registry"
        required: true
      registry_username:
        description: "Username to authenticate against container registry"
        required: true
      registry_password:
        description: "Password to authenticate against container registry"
        required: true

jobs:
  Build:
    runs-on: [self-hosted, protomodule]

    steps:      
      - 
        name: Checkout source code
        uses: actions/checkout@v2
      - 
        name: Login to container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.registry_url }}
          username: ${{ secrets.registry_username }}
          password: ${{ secrets.registry_password }}
          logout: true
      - 
        name: Build and push to registry
        run: |
          DOCKERFILE=${{ github.event.inputs.Dockerfile }}
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/protomodule/ops/main/helpers/generate-changelog.sh)" -- -x -n 100
          /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/protomodule/ops/main/helpers/docker-build.sh)" -- -f ${DOCKERFILE:-Dockerfile} $REPOSITORY
      -
        name: Set outputs
        run: |
          source version.sh
          echo "::set-output name=version::$VERSION"
          echo "::set-output name=commit::$COMMIT"
          echo "::set-output name=short::$SHORT"
          echo "::set-output name=branch::$BRANCH"
          echo "::set-output name=docker_tag::$DOCKER_TAG"
          echo "::set-output name=latest_tag::$LATEST_TAG"
          echo "::set-output name=buildtime::$TIMESTAMP"
          echo "::set-output name=repository::$REPOSITORY"
      -
        name: Upload changelog artifact
        uses: actions/upload-artifact@v3.1.0
        with:
          name: Changelog
          path: ${{ github.workspace }}/changelog.html
